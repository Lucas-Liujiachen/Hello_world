# \[Makefile学习笔记\]

## 一、简介

**makefile是一个对工程文件进行自动化编译的工具。**
makefile本质是一个文件，需要配合make指令来进行自动化编译。
make是一个命令工具，用来解释makefile中的代码，从而实现自动化编译，其使用的编译器仍然是gcc。
makefile文件中定义了一些规则来指定，哪些文件先编译，哪些文件后编译，哪些文件需要重新编译等等。
makefile文件一般命名为makefile或者Makefile。

## 二、原理

基本原来：若想生成目标文件，检查规则中所有依赖文件是都存在。

**依赖文件不存在：**

1. 若有的依赖文件不存在，那么则向下搜索，看看有没有规则来生成该目标文件。
2. 若有规则来生成依赖文件，那么按照该规则命令来生成依赖文件。
3. 若没有规则来生成该依赖文件，则报错。

**依赖文件存在：**

若依赖文件都存在，检查规则中的目标是否需要更新，必须先检查它所有的依赖，以来中任何一个被更新，则目标文件必须被更新

## 三、基本规则

### 1. makefile规则三要素

1. 目标：要生成的目标文件
2. 依赖：目标文件由那些文件生成
3. 命令：通过执行该命令由依赖文件生成目标

### 2. 基本规则

```makefile
目标：依赖
    命令     #其中命令必须以TAB键开始
```

```makefile
main:main.c test.c
    gcc main.c test.c -o main
```

### 3. 变量

makefile中的变量类似C语言中的宏定义，使用该变量相当于内容替换，使用变量可以使得makefile易于维护。

1. 普通变量
2. 自动变量
3. 自带变量

#### 3-1 普通变量

普通变量的定义使用"="：

```makefile
OBJS = main     #定义并赋值
$(OBJS)         #使用变量（取值）
```

#### 3-2 自动变量

&#10052;`$@`: 规则中的目标集合，在模式规则中，如果有多个目标的话，"\$@"表示匹配模式中定义的目标集合。
&#10052;`$<`：依赖文件集合中的第一个文件，如果依赖文件是以模式(即"\%")定义的，那么"\$<"就是符合模式的一系列的文件集合
&#10052;`$^`：所有依赖文件的集合，使用空格分开，如果在依赖文件中有多个重复的文件，会去除重复的依赖文件，只保留一份。
&#10052;`$%`：当目标是函数库的时候表示规则中的目标成员名，如果目标不是函数库文件，那么其值为空。
&#10052;`$?`：所有比目标新的依赖目标集合，以空格分开。
&#10052;`$+`：和"\$^"类似，但是当依赖文件存在重复的话不会去除重复的依赖文件。

`app: main.c func1.c fun2.c gcc $^ - o $@`
其中：`$^`表示main.c func1.c fun2.c，`$<`表示main.c，`$@`表示app。

#### 3-3 系统自带变量

系统自带变量通常都是大写，比如CC、PWD、CFLAG等
有些自带变量有默认值，比如：

&#10052;CPPFLAGS：预处理器需要的选项，如：-I
&#10052;CFLAGS：编译时使用的参数，如： -Wall -g -c
&#10052;LDFLAGS：链接库使用的选项，如： -L -l

变量的默认值是可以修改的比如CC的默认值是cc，但是可以修改为gcc：CC=gcc

jfklsdjlaff
dfddfsffdsfsf
